# Use an official Ubuntu as a parent image
FROM ubuntu:latest

# Set proxy environment variables
ARG http_proxy
ARG https_proxy
ARG no_proxy
ENV http_proxy=${http_proxy}
ENV https_proxy=${https_proxy}
ENV no_proxy=${no_proxy}

# Install required tools
RUN apt-get update && apt-get install -y \
    build-essential \
    curl \
    wget \
    git \
    vim \
    python3 \
    python3-pip \
    python3-venv \
    tesseract-ocr \
    libenchant-2-2 \
    libglib2.0-dev \
    enchant-2 \
    asciidoctor \
    bash \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Set the working directory for the project
WORKDIR /workspace

# Copy the requirements file
COPY ../requirements.txt /workspace

# Copy the tessdata.txt file
COPY ../tessdata.txt /workspace

# Copy the source code
COPY ../src /workspace/src

# Copy the scripts
COPY ../scripts /workspace/scripts

# Download Tesseract language data, removing any carriage return characters
RUN cat /workspace/tessdata.txt | tr -d '\r' | xargs -n 1 wget --no-check-certificate -P /usr/share/tesseract-ocr/4.00/tessdata/

# Create and activate a virtual environment and install dependencies
RUN python3 -m venv /workspace/venv && \
    /bin/bash -c "source /workspace/venv/bin/activate && pip install --no-cache-dir -r /workspace/requirements.txt && pip list"

# Set environment variables for the virtual environment
ENV PATH="/workspace/venv/bin:$PATH"

# Run bash by default
CMD ["bash"]
